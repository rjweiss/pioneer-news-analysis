---
title: "preliminary"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
#install.packages('lubridate')
#install.packages('stringr')
# install.packages("ggthemes")
# install.packages("pander")
# install.packages('ggeffects')
library(lubridate)
library(sparklyr)
library(dplyr)
library(ggplot2)
library(scales)
library(jsonlite)
library(stringr)
library(fuzzyjoin)
library(tidyr)
library(magrittr)
library(ggthemes)
library(knitr)
library(pander)
library(ggeffects)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(
  cache.path = '/home/hadoop/analyses/rweiss/pioneer-news-analysis/cache/',
  cache.extra = list(R.version, sessionInfo(), format(Sys.Date(), '%Y-%m'))
  )

#spark config
Sys.setenv(SPARK_HOME='/usr/lib/spark')
config <- spark_config()
config$spark.driver.memory <- "5G"
config$spark.executor.memory <- "5G"
config$spark.yarn.executor.memoryOverhead <- "2G"
config$spark.executor.core <- 3
config$spark.executor.instances <- 5
config$spark.sql.shuffle.partitions <- 320
sc <- spark_connect(master = "yarn-client", version = "1.6.2", config = config)

#dwell_parquet_dir = 's3://net-mozaws-data-us-west-2-data-pioneer-analysis/online_news_v2/dwell_time_complete/'
dwell_parquet_dir = 's3://net-mozaws-data-us-west-2-data-pioneer-analysis/online_news_v2/dwell_time_new_handling/'
dwell_tbl = spark_read_parquet(sc, name='dwell_tbl', path=dwell_parquet_dir, repartition=100)#, memory=TRUE, repartition=100) %>% sdf_register('dwell_tbl')

bias_json = 'https://raw.githubusercontent.com/mozilla/pioneer-study-online-news-2/master/extension/bias-domains.json'
whois_json = 'https://raw.githubusercontent.com/mozilla/pioneer-study-online-news-2/master/extension/whois-domains.json'
bias_scores = fromJSON(bias_json)
whois_scores = fromJSON(whois_json)
bias_scores$domain = str_replace(bias_scores$domain, 'www.','')

domains = dwell_tbl %>% group_by(domain) %>% count %>% collect
scored_domains = inner_join(bias_scores, domains, by='domain')
names(scored_domains) = c('domain', 'score','n')
scored_domains_tbl = sdf_copy_to(sc,scored_domains, overwrite = T)
scored_dwell_tbl = dwell_tbl %>% inner_join(scored_domains_tbl) %>% sdf_register('scored_dwell_tbl')
```

We begin with a description of the population itself.

# Data cleaning and preparation

## Dwell, idle, and active time
```{r activity_tbl, echo=FALSE, cache=TRUE}
dwell_clean_tbl = dwell_tbl %>% 
  filter(visit_start_date > "2018-01-01" & visit_start_date <"2018-05-01") %>% # remove odd clients, likely clock skew
  filter(days_since_appearance > 0 & days_since_appearance < 23) %>% # only look at study periods
  ft_string_indexer(input_col='pioneer_id', output_col='id') #%>% # recode pioneer ids

# annotate site session events per client with likely stage of study
dwell_stages_tbl = dwell_clean_tbl %>% 
  mutate(stage = case_when(
    days_since_appearance == 0 ~ 'enrollment',
    days_since_appearance > 0 & days_since_appearance < 8 ~ 'pretreatment',
    days_since_appearance >= 8 & days_since_appearance < 15 ~ 'treatment',
    days_since_appearance >=15 & days_since_appearance < 21 ~ 'posttreatment',
    days_since_appearance >=22 ~ 'after'
  ))

# compute active time (where dwell = active + idle time)
activity_tbl = dwell_stages_tbl %>% 
  #filter(domain != 'youtube.com' & domain != 'google.com' & domain!= 'facebook.com') %>% 
  mutate(total_active_time = total_dwell_time - total_idle_time) %>%
  filter(total_active_time < 5000) %>% # remove clients with active time greater than 99.999%
  sdf_register('activity_tbl')

# annotate site session events per client with likely stage of study
scored_activity_tbl = scored_dwell_tbl %>% 
  filter(visit_start_date > "2018-01-01" & visit_start_date <"2018-05-01") %>% # remove odd clients, likely clock skew
  filter(days_since_appearance > 0 & days_since_appearance < 23) %>% # only look at study periods
  mutate(stage = case_when(
    days_since_appearance == 0 ~ 'enrollment',
    days_since_appearance > 0 & days_since_appearance < 8 ~ 'pretreatment',
    days_since_appearance >= 8 & days_since_appearance < 15 ~ 'treatment',
    days_since_appearance >=15 & days_since_appearance < 21 ~ 'posttreatment',
    days_since_appearance >=22 ~ 'after')) %>%
  mutate(total_active_time = total_dwell_time - total_idle_time) %>%
  filter(total_active_time < 5000) %>% # remove clients with active time greater than 99.999%
  sdf_register('scored_activity_tbl')

# cache table for faster compute
#tbl_cache(sc, 'activity_tbl')
#tbl_cache(sc, 'scored_activity_tbl')
```


## Distribution of activity during the study period
```{r enrollment_plots}
visitdate_df = activity_tbl %>% 
  group_by(id, visit_start_date, stage) %>%
  count %>% collect

startdate_df = activity_tbl %>% 
  group_by(id, days_since_appearance, stage) %>%
  count %>% collect

ggplot(visitdate_df, aes(
  x=visit_start_date,
  y=n,
  color=stage
)) +
  geom_bar(stat='identity', width=.5) +
  guides(color=F) +
  theme_bw() + scale_color_solarized() + 
  labs(title = "Total domain dwell events observed during study by calendar date", subtitle = "Colored by enrollment period") +
  xlab('Date during study') + ylab('Total dwell events observed')

ggplot(startdate_df, aes(
  x=days_since_appearance,
  y=n,
  color=stage
)) +
  geom_bar(stat='identity', width=.5)+
  guides(color=F) +
  theme_bw() + scale_color_solarized() + 
  labs(title = "Total domain dwell events observed during study by enrollment date", subtitle = "Colored by enrollment period") +
  xlab('Days since enrollment') + ylab('Total dwell events observed')

ggplot(startdate_df, aes(
  x=days_since_appearance,
  y=log(n),
  group=days_since_appearance,
  color=stage)) +
  geom_boxplot() +
  guides(color=F) +
  theme_bw() + scale_color_solarized() +
  labs(title = "Logged total domain dwell events observed during study by enrollment date", subtitle = "Colored by enrollment period") +
  xlab('Days since enrollment') + ylab('Total dwell events observed')
```

## General activity of enrollees over all study periods
```{r daysactive_plots}
ecdf_activedays_df = activity_tbl %>%
  group_by(visit_start_date, branch, id) %>%
  count %>%
  filter(n>0)%>%
  group_by(id, branch)%>%
  count %>%
  collect

ggplot(ecdf_activedays_df, aes(nn)) + geom_histogram(binwidth=1,position='dodge') + 
  theme_bw()+
  labs(title = "Observed distribution of participant active days", subtitle = "Over all study periods")

ggplot(ecdf_activedays_df, aes(nn)) + stat_ecdf(geom='step') + 
  theme_bw() +
  labs(title = "Cumulative distribution of participant active days", subtitle = "Over all study periods")

ggplot(ecdf_activedays_df, aes(nn, fill=branch)) + 
  geom_histogram(binwidth=1,position='dodge') + 
  scale_fill_canva(palette='Tropical tones', 
                    guide=guide_legend(title='', label.position='bottom')) +
  labs(title = "Observed distribution of participant active days by branch", subtitle = "By branch") +
  theme_bw() + theme(legend.position="bottom")

ggplot(ecdf_activedays_df, aes(nn, color=branch)) + stat_ecdf(geom='step') + 
  scale_color_canva(palette='Tropical tones', 
                    guide=guide_legend(title='', label.position='bottom')) +
  theme_bw()+ theme(legend.position="bottom") +
  labs(title = "Cumulative distribution of participant active days", subtitle = "By branch")

```

### Without weekends?
```{r wdaysactive_plots}
# pdf_activewdays_df = activity_tbl %>%
#   group_by(visit_start_date, branch, id) %>%
#   count %>%
#   collect %>%
#   mutate(wday=wday(visit_start_date)) %>%
#   filter(n>0)%>%
#   ungroup %>% group_by(wday) %>%
#   count %>% collect
# 
# ecdf_activewdays_df = activity_tbl %>%
#   group_by(visit_start_date, branch, id) %>%
#   count %>%
#   collect %>%
#   mutate(wday=wday(visit_start_date)) %>%
#   filter(n>0 & wday !=1 & wday !=7)%>%
#   group_by(id, branch)%>%
#   count %>% collect
# 
# ggplot(ecdf_activewdays_df, aes(nn)) + 
#   geom_histogram(binwidth=1,position='dodge') + 
#   theme_bw() +
#   labs(title = "New plot title", subtitle = "A subtitle")
# 
# ggplot(ecdf_activewdays_df, aes(nn)) + 
#   stat_ecdf(geom='step') + 
#   theme_bw() +
#   labs(title = "New plot title", subtitle = "A subtitle")
# 
# ggplot(ecdf_activewdays_df, aes(nn, fill=branch)) + 
#   geom_histogram(binwidth=1,position='dodge') + 
#   scale_fill_canva(palette='Tropical tones', 
#                     guide=guide_legend(title='', label.position='bottom')) +
#   theme_bw()+ theme(legend.position="bottom") +
#   labs(title = "New plot title", subtitle = "A subtitle")
# 
# ggplot(ecdf_activewdays_df, aes(nn, color=branch)) + 
#   stat_ecdf(geom='step') + 
#   theme_bw()+ theme(legend.position="bottom") +
#   scale_color_canva(palette='Tropical tones', 
#                     guide=guide_legend(title='', label.position='bottom')) +
#   
#   labs(title = "New plot title", subtitle = "A subtitle")
# 
# kable(quantile(ecdf_activewdays_df$nn, probs=c(0, .25, .5, .75, .99, .999, .9999, 1)))

```

## Distribution of time of browsing

```{r timeofday}
hours = activity_tbl %>% mutate(timestamp=hour(from_unixtime(visit_start_time))) %>% select(timestamp) %>% group_by(timestamp) %>% count %>% collect
hours$timestamp = hours(hours$timestamp)

ggplot(hours, aes(x=timestamp, y=n)) + 
  geom_bar(stat='identity') + 
  scale_y_continuous(labels=comma) +
  scale_x_time(labels = date_format("%H:%M")) +
  theme_bw() 
```


## Average number of pageviews per day
```{r avg_pv_plots, cache=TRUE}
daily_pagevisits = activity_tbl %>%
  group_by(id,visit_start_date) %>%
  count %>%
  ungroup %>% group_by(id) %>%
  summarise(
    mu=mean(n, na.rm=T)
  ) %>%
  filter(mu<800) %>%
  collect

ggplot(daily_pagevisits, aes(x=mu)) + 
  geom_histogram(binwidth=1) + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_pagevisits, aes(x=mu)) + 
  stat_ecdf() + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_pagevisits, aes(x=log(mu))) + 
  geom_histogram(binwidth=.01) + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_pagevisits, aes(x=log(mu))) + 
  stat_ecdf() + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

kable(quantile(daily_pagevisits$mu, probs=c(0, .25, .5, .75, .99, .999, .9999, 1)))


```

### Average total active browsing per day
```{r avg_ab_plots, cache=TRUE}
daily_active_browsing = activity_tbl %>%
  group_by(id,days_since_appearance) %>%
  summarise(total_s=sum(total_active_time, na.rm=T)) %>%
  filter(total_s<17290.93) %>%
  mutate(total_m=total_s/60) %>%
  mutate(total_h=total_m/24) %>%
  filter(total_m>1)%>%
  collect

ggplot(daily_active_browsing, aes(x=total_h)) + 
  stat_ecdf() + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_active_browsing, aes(x=log(total_h))) + 
  stat_ecdf() + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_active_browsing, aes(x=total_m)) + 
  stat_ecdf() + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_active_browsing, aes(x=log(total_m))) + 
  stat_ecdf() + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_active_browsing, aes(x=total_h)) + 
  geom_histogram(bins=1000, labels=comma) + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_active_browsing, aes(x=total_m)) + 
  geom_histogram(bins=1000, labels=comma) + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

ggplot(daily_active_browsing, aes(x=log(total_m))) + 
  geom_histogram(bins=1000, labels=comma) + 
  theme_bw() +
  labs(title = "New plot title", subtitle = "A subtitle")

kable(quantile(daily_active_browsing$total_m, probs=c(0, .25, .5, .75, .99, .999, .9999, 1)))

```



### Length of average site visit
```{r avg_sv_plots, cache=TRUE}
daily_avg_activity=activity_tbl %>%
   group_by(id, days_since_appearance) %>%
   summarise(
    mean=mean(total_active_time, na.rm=T),
    n = n()) %>%
  ungroup %>% group_by(days_since_appearance) %>%
  filter(mean>1) %>%
  collect

ggplot(daily_avg_activity, aes(x=mean)) + 
  geom_histogram(binwidth=.1) +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  theme_bw()

ggplot(daily_avg_activity, aes(x=log(mean))) + 
  geom_histogram(binwidth=.01) + 
  scale_y_continuous(labels = comma) +
  theme_bw()

ggplot(daily_avg_activity, aes(x=days_since_appearance, y=mean, group=days_since_appearance)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = comma) +
  theme_bw()

ggplot(daily_avg_activity, aes(x=days_since_appearance, y=log(mean), group=days_since_appearance)) + 
  geom_boxplot() + 
  scale_y_continuous(labels = comma) +
  theme_bw()

kable(quantile(daily_avg_activity$mean, probs=c(0, .25, .5, .75, .99, .999, .9999, 1)))
```

## Self report

```{r}
source('/home/hadoop/analyses/rweiss/pioneer-news-analysis/survey_recoding.R')
```


### Demographics: Partisan ID, Age, Gender

### Browsing patterns against self report

# Analysis

## Browsing scored domains
```{r align_activity, cache=TRUE}
#scored_activity_tbl = activity_tbl %>% 
#  inner_join(scored_domains_tbl) %>% 
  

# align_dist = scored_activity_tbl %>%
#   #mutate(scored_active_time = total_active_time * abs(score)) %>% # every session's active time * absolute value of the score
#   group_by(id, score, branch, stage) %>%
#   summarise(scored_active=mean(log(total_active_time), na.rm=T)*abs(score)) %>%
#   filter(stage == 'pretreatment' & stage == 'posttreatment') %>%
#   collect
#   
# ggplot(align_dist, aes(
#   x=scored_active,
#   fill=stage)) + 
#   geom_density() + 
#   theme_bw() + theme(legend.position='bottom') +
#   labs(title = "New plot title", subtitle = "A subtitle")
```


```{r scaled_browsing}

# df = scaled_browsing %>% group_by(id, branch,days_since_appearance) %>% select(id, days_since_appearance, scaled_active_bias_s) %>% collect
# 
# ggplot(df, aes(
#   x=scaled_active_bias_s,
#   fill=branch
# )) + geom_density() +
#   theme_bw()
```

## Browsing scored domains by partisan group

```{r pid_browsing}

pid_tbl = sdf_copy_to(sc,pid, overwrite=T)
valids_tbl = sdf_copy_to(sc,valids,overwrite=T)

daily_pid_scored_sessions = scored_activity_tbl %>% inner_join(valids_tbl) %>%
  filter(domain != 'youtube.com' & domain != 'google.com' & domain!= 'facebook.com') %>% 
  inner_join(pid_tbl) %>%
  group_by(id, pid, score, days_since_appearance) %>%
  summarise(
    total_active_time_s = sum(total_active_time, na.rm=T)) %>%
  ungroup %>% group_by(id, score, pid) %>%
  filter(pid == 'D' | pid == 'R' | pid == 'I') %>%
  collect



daily_pid_scored_browsing %>% scored_activity_tbl %>% inner_join(valids_tbl) %>%
  filter(domain != 'youtube.com' & domain != 'google.com' & domain!= 'facebook.com') %>% 
  inner_join(pid_tbl) %>%
  group_by(pid, days_since_appearance) %>%
  summarise(
   daily_sum_time = sum(total_active_time_s, na.rm=T),
   daily_avg_time = mean(total_active_time_s, na.rm=T)) %>%
  collect


ggplot(daily_pid_scored_browsing, aes(
  x=score,
  fill=pid, 
  alpha=0.5)) + stat_density(position='dodge') + theme_bw()


ggplot(daily_pid_scored_browsing, aes(
  x=reorder(score, score), y=daily_sum_time, fill=pid))+ geom_histogram(stat='identity', position='dodge')

```

## Effect of treatments on browsing
```{r maineffect, cache=TRUE}

scaled_browsing = scored_activity_tbl %>%
  filter(domain != 'youtube.com' & domain != 'google.com' & domain!= 'facebook.com') %>% 
  group_by(id, stage, branch, days_since_appearance) %>%
  summarise(
    scored_active_time_s = sum(scored_active_time, na.rm=T),
    total_active_time_s = sum(total_active_time, na.rm=T)) %>%
  mutate(scaled_active_bias_s = scored_active_time_s/total_active_time_s)

treatment_spark = scaled_browsing %>%
  sdf_pivot(id + days_since_appearance + branch + scaled_active_bias_s ~ stage) %>%
  na.replace(0) %>%
  mutate(pretreatment = pretreatment * scaled_active_bias_s) %>%
  mutate(treatment = treatment * scaled_active_bias_s) %>%
  mutate(posttreatment = posttreatment * scaled_active_bias_s) %>%
  mutate(
    condition = case_when(
      branch=='control'~'Control',
      branch=='treatment-bias'~'Treatment',
      branch=='treatment-whois'~'APlacebo'
    ))

fit1 = glm(data=treatment_spark, formula=posttreatment~pretreatment + condition)
summary(fit1)

fit2 = glm(data=treatment_spark, formula=posttreatment~pretreatment*condition + condition)
summary(fit2)

dat = ggpredict(fit2, terms = c('pretreatment','condition'))
plot(dat, facet=T) + theme_bw()
```